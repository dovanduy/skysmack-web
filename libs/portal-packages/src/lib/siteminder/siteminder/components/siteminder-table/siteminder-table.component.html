<ng-container *ngIf="uiOptions$ | async as uiOptions">
  <!-- Filters -->
  <ul>
    <li>Hide rates: {{ uiOptions.hideRates.toString() }} - <span style="cursor:pointer;"
        (click)="testUpdate('rates', !uiOptions.hideRates)">toggle</span>
    </li>
    <li>Hide restrictions: {{ uiOptions.hideRestrictions.toString() }} - <span style="cursor:pointer;"
        (click)="testUpdate('restrictions', !uiOptions.hideRestrictions)">toggle</span></li>
    <li>Hide all section: {{ uiOptions.hideAll.toString() }} - <span style="cursor:pointer;"
        (click)="testUpdate('all', !uiOptions.hideAll)">toggle</span></li>
    <li>Hide availability: {{ uiOptions.hideAvailability.toString() }} - <span style="cursor:pointer;"
        (click)="testUpdate('availability', !uiOptions.hideAvailability)">toggle</span></li>
  </ul>


  <!-- Table -->
  <ng-container *ngIf="columns$ | async as columns">
    <mat-card>
      <cdk-virtual-scroll-viewport #entityList id="entity-list" itemSize="40" (scrolledIndexChange)="whenScrolling()">
        <table cellspacing="0" cellpadding="0" class="mat-table">
          <thead class="mat-header-row">
            <!-- 1st header row -->
            <tr>
              <!-- Date -->
              <th rowspan="4" class="table-cell mat-header-cell border-right">
                {{  columns.dateColumn.title }}
              </th>
              <ng-container *ngFor="let ltc of columns.lodgingTypeColumns; let first = first; let last = last">
                <!-- Lodging Type -->
                <th [attr.colspan]="(lodgingTypeColspan$ | async)"
                  class="table-cell mat-header-cell lodging-type-column-divider border-left border-right">
                  {{ ltc.title }}
                </th>
              </ng-container>
            </tr>

            <!-- 2nd header row -->
            <tr>
              <ng-container *ngFor="let ltc of columns.lodgingTypeColumns">
                <!-- Available -->
                <th *ngIf="!uiOptions.hideAvailability" rowspan="3"
                  class="table-cell mat-header-cell border-left border-right">
                  {{ columns.availabilityColumns[ltc.id]?.title }}
                </th>
                <!-- Rateplan -->
                <ng-container *ngIf="(ratePlanColspan$ | async) !== 0">
                  <ng-container
                    *ngFor="let ratePlanColumn of columns.ratePlanColumns[ltc.id]; let first = first; let last = last">
                    <th [attr.colspan]="(ratePlanColspan$ | async)" class="table-cell mat-header-cell border-right">
                      {{ ratePlanColumn.title }}
                    </th>
                  </ng-container>
                </ng-container>
              </ng-container>
            </tr>

            <!-- 3rd header row -->
            <tr>
              <ng-container *ngFor="let ltc of columns.lodgingTypeColumns">
                <!-- Rateplan -->
                <ng-container *ngFor="let ratePlanColumn of columns.ratePlanColumns[ltc.id]">
                  <!-- All section -->
                  <ng-container *ngIf="(allColspan$ | async) !== 0">
                    <th [attr.colspan]="(allColspan$ | async)" class="table-cell mat-header-cell border-right-light">
                      {{ columns.rateSummaryColumns[ratePlanColumn.id].title }}
                    </th>
                  </ng-container>

                  <!-- Channels (show if expanded) -->
                  <ng-container *ngIf="(channelsColspan$ | async) !== 0">
                    <ng-container
                      *ngFor="let channelColumn of columns.channelsColumns[ratePlanColumn.id]; let first = first; let last = last">
                      <th [attr.colspan]="(channelsColspan$ | async)" [ngClass]="{ 'border-right-light': !last }"
                        class="table-cell mat-header-cell border-right">
                        {{ channelColumn.title }}
                      </th>
                    </ng-container>
                  </ng-container>
                </ng-container>
              </ng-container>
            </tr>

            <!-- 4th header row -->
            <tr>
              <ng-container *ngFor="let ltc of columns.lodgingTypeColumns">
                <!-- Rateplan -->
                <ng-container *ngFor="let ratePlanColumn of columns.ratePlanColumns[ltc.id]">

                  <!-- All section -->
                  <ng-container *ngIf="!uiOptions.hideAll">
                    <!-- Rates -->
                    <ng-container *ngIf="!uiOptions.hideRates">
                      <th class="table-cell mat-header-cell border-right-light">
                        Rates
                      </th>
                    </ng-container>
                    <!-- Restrictions -->
                    <ng-container *ngIf="!uiOptions.hideRestrictions">
                      <th class="table-cell mat-header-cell border-right-light">
                        Restriction summary
                      </th>
                    </ng-container>
                  </ng-container>

                  <!-- Channels (show if expanded) -->
                  <ng-container *ngIf="columns.channelsColumns">
                    <ng-container
                      *ngFor="let channelColumn of columns.channelsColumns[ratePlanColumn.id]; let first = first; let last = last">
                      <!-- Rates -->
                      <ng-container *ngIf="!uiOptions.hideRates">
                        <th [ngClass]="{ 'border-right-light': true }" class="table-cell mat-header-cell border-right">
                          Rate
                        </th>
                      </ng-container>
                      <!-- Restrictions -->
                      <ng-container *ngIf="!uiOptions.hideRestrictions">
                        <th [ngClass]="{ 'border-right-light': !last }" class="table-cell mat-header-cell border-right">
                          Restrictions
                        </th>
                      </ng-container>
                    </ng-container>
                  </ng-container>

                </ng-container>
              </ng-container>
            </tr>

          </thead>
          <tbody *ngIf="cells$ | async as cells">
            <tr
              *cdkVirtualFor="let date of dateRows$ | async; let firstRow = first; trackBy: trackByDate; let i = index;"
              [ngClass]="'row-weekday-' + (date | weekday)" [attr.data-index]="i">

              <!-- Date -->
              <td class="table-cell mat-cell border-right" [matTooltip]="(date | weekday : 'readable')">
                {{ date | date: 'dd-MM-yyyy' }}
              </td>

              <ng-container *ngFor="let ltc of columns.lodgingTypeColumns; trackBy: trackByColumnId">
                <!-- Available -->
                <td *ngIf="!uiOptions.hideAvailability" class="table-cell mat-cell border-left border-right">

                  <ss-siteminder-availability [data]="cells.availabilityCells[date][ltc.id]">
                  </ss-siteminder-availability>

                </td>

                <!-- Rateplan -->
                <ng-container
                  *ngFor="let ratePlanColumn of columns.ratePlanColumns[ltc.id];  trackBy: trackByColumnId; let last = last">
                  <!-- All section -->
                  <ng-container *ngIf="!uiOptions.hideAll">
                    <!-- Rates summary -->
                    <ng-container *ngIf="!uiOptions.hideRates">
                      <td class="table-cell mat-cell border-right-light">
                        <ss-siteminder-rate-summary [data]="cells.rateSummaryCells[date][ratePlanColumn.id][ltc.id]">
                        </ss-siteminder-rate-summary>

                      </td>
                    </ng-container>

                    <!-- Restrictions summary -->
                    <ng-container *ngIf="!uiOptions.hideRestrictions">
                      <td class="table-cell mat-cell border-right-light">
                        <ss-siteminder-restrictions-summary
                          [data]="cells.rateSummaryCells[date][ratePlanColumn.id][ltc.id]">
                        </ss-siteminder-restrictions-summary>
                      </td>
                    </ng-container>
                  </ng-container>


                  <!-- Channels (show if expanded) -->

                  <ng-container
                    *ngFor="let channelColumn of columns.channelsColumns[ratePlanColumn.id];  trackBy: trackByColumnId; let last = last">
                    <!-- Channel: Rates -->
                    <ng-container *ngIf="!uiOptions.hideRates">
                      <td class="table-cell mat-cell border-right-light">
                        <ss-siteminder-rate
                          [data]="cells.channelsCells[date][ratePlanColumn.id][ltc.id][ltc.id + ':' + ratePlanColumn.id + ':' + channelColumn.id]">
                        </ss-siteminder-rate>
                      </td>
                    </ng-container>
                    <!-- Channel: Restrictions -->
                    <ng-container *ngIf="!uiOptions.hideRestrictions">
                      <td class="table-cell mat-cell border-right" [ngClass]="{ 'border-right-light': !last }">
                        <!-- Restrictions -->
                        <ss-siteminder-restrictions
                          [data]="cells.channelsCells[date][ratePlanColumn.id][ltc.id][ltc.id + ':' + ratePlanColumn.id + ':' + channelColumn.id]">
                        </ss-siteminder-restrictions>
                      </td>
                    </ng-container>
                  </ng-container>

                </ng-container>
              </ng-container>
            </tr>
          </tbody>
        </table>
      </cdk-virtual-scroll-viewport>
    </mat-card>
  </ng-container>

</ng-container>